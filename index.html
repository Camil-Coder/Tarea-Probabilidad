<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tarea probabilidad ‚Äî visor de datos y histogramas</title>

<!-- Plotly (histogramas) -->
<script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
<!-- SheetJS (leer Excel en el navegador) -->
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<link rel="stylesheet" href="style.css">
</head>

<body>
  <div class="wrap" style="max-width: 70%;">
    <header>
      <h1>Tarea probabilidad</h1>
    </header>

    <div class="toolbar">
      <label class="file-label">
        <input id="file" type="file" accept=".xlsx,.xls" hidden />
        üìÇ Cargar Excel
      </label>

      <div style="display:flex; gap:10px; align-items:center;">
        <label>Ciudad&nbsp;
          <select id="ciudad"></select>
        </label>
        <label>Variable&nbsp;
          <select id="variable">
            <option value="vel_viento (m/s)">vel_viento (m/s)</option>
            <option value="T (¬∞C)">T (¬∞C)</option>
          </select>
        </label>
        <label>Bins&nbsp;
          <input id="bins" type="number" min="5" max="80" value="20" />
        </label>
        <button id="btnHist" class="btn primary">Generar histograma</button>
      </div>
    </div>

    <div id="dz" class="dropzone">Suelta aqu√≠ tu archivo <b>Datos.xlsx</b> o usa el bot√≥n ‚ÄúCargar Excel‚Äù.</div>

    <section class="board">
      <div class="card">
        <h3>Tabla de datos (filtrable)</h3>
        <div class="grid">
          <table id="tabla"></table>
        </div>
      </div>

      <div class="card">
        <h3>Histograma</h3>
        <div id="chart" style="height:420px;"></div>
        <div class="stats" id="stats"></div>
      </div>
    </section>

    <footer>Hecho para Barranquilla y Medell√≠n, pero funciona con cualquier municipio en tu dataset.</footer>
  </div>

<script>
  // --- Utilidades de UI ---
  const byId = id => document.getElementById(id);
  const $file = byId('file'),
        $ciudad = byId('ciudad'),
        $variable = byId('variable'),
        $bins = byId('bins'),
        $btnHist = byId('btnHist'),
        $tabla = byId('tabla'),
        $chart = byId('chart'),
        $stats = byId('stats'),
        $dz = byId('dz');

  let DATA = [];          // arreglo de objetos (filas completas)
  let HEADERS = [];       // nombres de columna
  let FILTERS = {};       // filtros por columna (texto)
  const REQUIRED = ["fecha","T (¬∞C)","Tmin (¬∞C)","Tmax (¬∞C)","Precipitaciones (mm)","dir_viento (¬∞)","vel_viento (m/s)","pres (hPa)","Municipio"];

  // Drag & drop
  ['dragenter','dragover'].forEach(ev => $dz.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); $dz.classList.add('drag');}));
  ['dragleave','drop'].forEach(ev => $dz.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); $dz.classList.remove('drag');}));
  $dz.addEventListener('drop', e => { const f = e.dataTransfer.files?.[0]; if (f) readFile(f); });

  // Input file
  $file.addEventListener('change', e => { const f = e.target.files?.[0]; if (f) readFile(f); });

  // Leer Excel con SheetJS
  async function readFile(file){
    const buffer = await file.arrayBuffer();
    const wb = XLSX.read(buffer, {type:'array'});
    // Tomamos la primera hoja
    const sheetName = wb.SheetNames[0];
    const ws = wb.Sheets[sheetName];
    let rows = XLSX.utils.sheet_to_json(ws, {defval:null});
    if(!rows.length){ alert("La hoja est√° vac√≠a."); return; }

    // Normalizar cabeceras: respetamos exactas, pero verificamos presencia
    HEADERS = Object.keys(rows[0]);
    const missing = REQUIRED.filter(h => !HEADERS.includes(h));
    if(missing.length){
      alert("Faltan estas columnas requeridas:\n- " + missing.join("\n- "));
      // Continuamos igual, pero recomendamos corregir nombres.
    }

    DATA = rows;
    buildCityOptions();
    renderTable();
    $dz.innerHTML = `‚úÖ Archivo cargado: <b>${file.name}</b> ‚Äî ${rows.length} filas`;
  }

  function buildCityOptions(){
    const set = new Set(DATA.map(r => r['Municipio']).filter(Boolean));
    const cities = [...set].sort((a,b)=> String(a).localeCompare(String(b),'es',{sensitivity:'base'}));
    $ciudad.innerHTML = cities.map(c => `<option value="${c}">${c}</option>`).join('');
    // Preseleccionar Barranquilla o Medell√≠n si existen
    const pref = cities.find(c=>/barranquilla/i.test(c)) || cities.find(c=>/medell[i√≠]n/i.test(c)) || cities[0];
    if (pref) $ciudad.value = pref;
  }

  // ---- Tabla con filtros por columna ----
  function renderTable(){
    if(!DATA.length) return;
    HEADERS = Object.keys(DATA[0]);

    // Encabezado con inputs de filtro
    const thead =
      `<thead>
        <tr>${HEADERS.map(h=>`<th>${h}</th>`).join('')}</tr>
        <tr>
        ${HEADERS.map(h=>`<th><input data-col="${h}" placeholder="Filtrar‚Ä¶"/></th>`).join('')}
        </tr>
      </thead>`;

    // Cuerpo (limitar a primeras 1500 filas para rendimiento)
    const filtered = applyFilters(DATA);
    const rowsHtml = filtered.slice(0,1500).map(r =>
      `<tr>${HEADERS.map(h=>`<td>${escapeHtml(r[h])}</td>`).join('')}</tr>`
    ).join('');

    $tabla.innerHTML = thead + `<tbody>${rowsHtml}</tbody>`;

    // Listeners de filtro
    $tabla.querySelectorAll('thead input').forEach(inp=>{
      const col = inp.dataset.col;
      inp.value = FILTERS[col] || '';
      inp.addEventListener('input', e=>{
        FILTERS[col] = e.target.value;
        renderTable();
      });
    });
  }

  function applyFilters(rows){
    const active = Object.entries(FILTERS).filter(([,v])=>v && v.trim().length);
    if(!active.length) return rows;
    return rows.filter(r=>{
      return active.every(([col,val])=>{
        const cell = (r[col] ?? '').toString();
        return cell.toLowerCase().includes(val.toLowerCase());
      });
    });
  }

  function escapeHtml(v){
    if(v===null || v===undefined) return '';
    return String(v).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  // ---- Histograma ----
  $btnHist.addEventListener('click', () => drawHistogram());

  function drawHistogram(){
    if(!DATA.length){ alert("Primero carga el Excel."); return; }
    const city = $ciudad.value;
    const col = $variable.value;

    // Filtrar por ciudad y columna num√©rica v√°lida
    const vec = DATA
      .filter(r => r['Municipio'] === city)
      .map(r => r[col])
      .filter(v => v !== null && v !== undefined && v !== "" && !isNaN(Number(v)))
      .map(Number);

    if(!vec.length){ alert(`No hay datos num√©ricos para "${col}" en ${city}.`); return; }

    const nbins = Math.max(5, Math.min(80, parseInt($bins.value || 20)));

    const trace = {
      type:'histogram',
      x: vec,
      nbinsx: nbins,
      marker: { line: { width: 1, color: '#0b1220' } },
      hovertemplate: 'bin: %{x}<br>freq: %{y}<extra></extra>'
    };

    const layout = {
      margin:{l:50,r:20,t:20,b:45},
      paper_bgcolor:'rgba(0,0,0,0)', plot_bgcolor:'rgba(0,0,0,0)',
      font:{color:'#e8eefc'},
      xaxis:{title: col},
      yaxis:{title:'Frecuencia', gridcolor:'#1c2a49'},
      bargap:0.05
    };

    Plotly.newPlot($chart, [trace], layout, {displayModeBar:true, responsive:true});

    // Estad√≠sticos
    const n = vec.length;
    const mean = vec.reduce((a,b)=>a+b,0)/n;
    const sd = Math.sqrt(vec.reduce((s,x)=>s+(x-mean)**2,0)/(n-1));
    const cv = sd/mean;

    $stats.innerHTML = [
      stat('Ciudad', city),
      stat('Variable', col),
      stat('n', n),
      stat('Media', mean.toFixed(3)),
      stat('Desv. Est.', sd.toFixed(3)),
      stat('CV', (cv*100).toFixed(2) + ' %')
    ].join('');
  }

  function stat(label, val){
    return `<div class="stat"><b style="color:#e8eefc">${label}:</b> ${val}</div>`;
  }
</script>
</body>
</html>
